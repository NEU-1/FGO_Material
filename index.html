<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>FGO 이벤트 주회 시뮬레이터 (CDN)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root{--bg:#0f172a;--card:#0b1223;--muted:#94a3b8;--fg:#e5e7eb;--acc:#22d3ee;--ok:#34d399;--err:#f87171}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,'Noto Sans KR',sans-serif}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    .card{background:linear-gradient(180deg,#0b1223,#0b1223 60%,#0b1223aa);border:1px solid #1f2937;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{font-size:22px;margin:0 0 10px}.sub{color:var(--muted);font-size:14px;margin-bottom:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}.grow{flex:1}
    input[type="number"],input[type="text"],input[type="file"]{background:#0b1223;border:1px solid #1f2937;border-radius:10px;color:var(--fg);padding:10px 12px}
    input[type="number"]{width:140px}
    label.sm{font-size:13px;color:var(--muted);display:block;margin-bottom:4px}
    .grp{display:flex;gap:12px;flex-wrap:wrap;margin:6px 0 12px}
    button{background:var(--acc);color:#001018;border:0;border-radius:12px;padding:10px 16px;font-weight:700;cursor:pointer}
    button.ghost{background:#0b1223;color:var(--fg);border:1px solid #1f2937}
    button:disabled{opacity:.6;cursor:not-allowed}.hint{color:var(--muted);font-size:13px}
    .tblwrap{max-height:420px;overflow:auto;border:1px solid #1f2937;border-radius:12px}
    table{border-collapse:collapse;width:100%;font-size:14px}
    th,td{border-bottom:1px solid #1f2937;padding:8px 10px;text-align:left}
    thead th{position:sticky;top:0;background:#0b1223;z-index:1}
    pre{white-space:pre-wrap;background:#0b1223;border:1px solid #1f2937;border-radius:12px;padding:16px;min-height:220px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1223;border:1px solid #1f2937;font-size:12px;color:var(--muted)}
    .ok{color:var(--ok)}.err{color:var(--err)}
    .loader{display:inline-block;width:16px;height:16px;border:3px solid #1f2937;border-top-color:var(--acc);border-radius:50%;animation:spin 1s linear infinite;vertical-align:-3px;margin-right:6px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .bar{height:8px;border:1px solid #1f2937;border-radius:999px;overflow:hidden}.bar>i{display:block;height:100%;background:linear-gradient(90deg,#0891b2,#22d3ee);width:0%}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0 10px}.right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>FGO 이벤트 주회 시뮬레이터</h1>
      <div class="sub">
        첫 로딩은 브라우저가 파이썬을 준비하느라 <b>10~25초</b> 걸릴 수 있어요. 준비되면 <b>사과 수량</b>과 <b>아이템 수량의 현재/목표</b>를 입력하고 <b>실행</b>을 누르세요.
      </div>

      <!-- 부팅 표시 -->
      <div id="boot" class="card" style="padding:14px; margin:10px 0 18px;">
        <div class="row">
          <div class="grow">
            <div><span class="loader"></span><b>Pyodide 로딩 중…</b> (인터넷 속도에 따라 10~25초)</div>
            <div class="bar" style="margin-top:10px;"><i id="pbar"></i></div>
            <div class="hint" id="bootmsg">파이썬 런타임 다운로드 중</div>
          </div>
          <span class="badge">CDN</span>
        </div>
      </div>

      <!-- 사과 입력 -->
      <div class="grp">
        <div><label class="sm">금사과</label><input id="apple-gold" type="number" min="0" step="1" value="0"></div>
        <div><label class="sm">은사과</label><input id="apple-silver" type="number" min="0" step="1" value="0"></div>
        <div><label class="sm">청사과</label><input id="apple-blue" type="number" min="0" step="1" value="0"></div>
        <div><label class="sm">동사과</label><input id="apple-copper" type="number" min="0" step="1" value="0"></div>
      </div>

      <!-- 재료 표/검색/업로드 -->
      <div class="row" style="margin:12px 0">
        <div class="grow">
          <div class="toolbar">
            <input id="search" type="text" placeholder="아이템 검색(이름 일부)" />
            <span class="right badge">AP/판=40 · text+ascii</span>
          </div>

          <div class="toolbar">
            <div class="grow hint">기본은 모든 재료 <b>0</b>으로 시작합니다. 필요하면 아래에서 <b>materials.json 업로드</b>로 교체하세요.</div>
            <label class="sm" style="margin:0">materials.json 업로드</label>
            <input id="matUpload" type="file" accept="application/json" /> <span id="matUploadName" class="badge" title="업로드 인식된 파일명" style="display:none;margin-left:8px"></span>
          </div>

          <div class="tblwrap">
            <table id="matTable">
              <thead><tr><th>재료</th><th>레어도</th><th>ap/개</th><th>보유량</th><th>목표량</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="toolbar">
            <button id="runBtn" disabled>시뮬레이션 실행</button>
            <button id="resetBtn" class="ghost" disabled>입력값 초기화</button>
            <button id="dlBtn" class="ghost right" disabled>로그 다운로드</button>
          </div>
        </div>
      </div>

      <pre id="out">출력 준비 중…</pre>
    </div>
  </div>

  <script>
    const setP = (pct, msg) => {
      const el = document.querySelector('#pbar'); if(el) el.style.width = pct + '%';
      const m  = document.querySelector('#bootmsg'); if(m && msg) m.textContent = msg;
    };
  </script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"></script>

  <script>
    // ===== 1) JSON 로드 =====
    async function loadJsonFiles() {
      const [materials, quests, items] = await Promise.all([
        fetch('materials.json').then(r=>r.json()),
        fetch('event_quests.json').then(r=>r.json()),
        fetch('event_items.json').then(r=>r.json()),
      ]);
      return { materials, quests, items };
    }

    // ===== 2) 재료 표 렌더링(사과/특정 항목 숨김 & QP 100만 단위 표기) =====
    let BASE = { materials:null, quests:null, items:null };

    const HIDE_BY_KEYWORD = ['사과','퓨어','프리즘','인연','종화','묘목']; // 포함시 숨김
    const EXACT_HIDE = new Set(['금사과','은사과','청사과','동사과','퓨어프리즘','묘목']); // 정확히 숨김
    const FORCE_NEED_1M_KEYWORD = ['인연','종화']; // 목표 100만 강제
    const NAME_QP = 'QP';
    const MILLION = 1_000_000;

    // 업로드/리셋 기준 스냅샷(Reset 버튼 동작용)
    let RESET_SNAPSHOT = null;

    function shouldHide(name){
      if (EXACT_HIDE.has(name)) return true;
      return HIDE_BY_KEYWORD.some(k => name.includes(k));
    }
    function isForceNeed1M(name){
      return FORCE_NEED_1M_KEYWORD.some(k => name.includes(k));
    }
    function labelFor(name){
      if (name === NAME_QP) return 'QP(100만 단위)';
      if (name === NAME_인연) return '인연(100 단위)';
      return name;
    }

    // 업로드하지 않은 기본 시작: 모든 have/need 0으로 초기화
    function makeZeroBaseline(materialsJson){
const out = structuredClone(materialsJson);
  for (const m of (out.materials||[])){
    m['보유량'] = 0;
    m['목표량'] = 0;
    delete m.have; delete m.need; delete m.lack; delete m.use;
  }
  return out;
    }

    // 숨김/강제 정책 적용
    function applyHiddenItemPolicies(){
const rows = BASE.materials.materials || [];
  for (const m of rows){
    const name = String(m.item||'');
    if (isForceNeed1M(name)){
      const hv = Number(('보유량' in m ? m['보유량'] : (m.have ?? 0)) || 0);
      m['보유량'] = hv;
      m['목표량'] = MILLION;
    }
    delete m.have; delete m.need; delete m.lack; delete m.use;
  }
    }

    function renderTable(filter='') {
const tbody = document.querySelector('#matTable tbody');
  tbody.innerHTML = '';
  const rows = BASE.materials.materials || [];
  const kw = (filter||'').trim();
  for (const m of rows) {
    const rawName = String(m.item||'');
    if (shouldHide(rawName)) continue;
    if (kw && !rawName.includes(kw)) continue;

    const isQP = (rawName === NAME_QP);
    const is인연 = (rawName === NAME_인연);
    const haveRaw = ('보유량' in m) ? m['보유량'] : (m.have ?? 0);
    const needRaw = ('목표량' in m) ? m['목표량'] : (m.need ?? 0);
    const dispHave = isQP ? Math.floor(Number(haveRaw||0)/MILLION) : Number(haveRaw||0);
    const dispNeed = isQP ? Math.floor(Number(needRaw||0)/MILLION) : Number(needRaw||0);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${labelFor(rawName)}</td>
      <td>${m.tier??''}</td>
      <td>${(m.ap_per_item??0).toLocaleString(undefined,{maximumFractionDigits:2})}</td>
      <td><input type="number" step="1" value="${dispHave}" data-name="${rawName}" data-field="보유량" ${isForceNeed1M(rawName)?'disabled':''}></td>
      <td><input type="number" step="1" value="${dispNeed}" data-name="${rawName}" data-field="목표량" ${isForceNeed1M(rawName)?'disabled':''}></td>
    `;
    tbody.appendChild(tr);
  }
    }

    function readEditsIntoMaterials() {
const map = new Map((BASE.materials.materials||[]).map(m=>[String(m.item||''), m]));
  const inputs = document.querySelectorAll('input[data-name]');
  inputs.forEach(inp=>{
    const name  = inp.getAttribute('data-name');
    const field = inp.getAttribute('data-field'); // '보유량' | '목표량'
    const row = map.get(name);
    if (!row) return;
    let v = Number(inp.value);
    if (!Number.isFinite(v)) v = 0;
    if (name === NAME_QP) v = v * MILLION;
    row[field] = v;
    delete row.have; delete row.need; delete row.lack; delete row.use;
  });
    }

    function resetInputs() {
      if (RESET_SNAPSHOT){
        BASE.materials = structuredClone(RESET_SNAPSHOT);
      }
      applyHiddenItemPolicies();
      renderTable(document.querySelector('#search').value||'');
      // 사과 입력은 0으로 초기화
      document.querySelector('#apple-gold').value   = 0;
      document.querySelector('#apple-silver').value = 0;
      document.querySelector('#apple-blue').value   = 0;
      document.querySelector('#apple-copper').value = 0;
    }

    // ===== 3) Pyodide 부팅 & 파일 쓰기 =====
    let pyodide = null;
    async function bootPyodide() {
      setP(10,'파이썬 런타임 다운로드 중');
      pyodide = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.26.2/full/' });
      setP(60,'런타임 초기화…');
      pyodide.FS.mkdirTree('/');
      setP(80,'Python 스크립트 준비…');
    }

    async function writeFiles() {
const rows = BASE.materials.materials || [];
  const outRows = [];
  for (const m of rows){
    const name = String(m.item||'');
    const forceKeep = (isForceNeed1M(name) || name === NAME_QP);
    if (shouldHide(name) && !forceKeep) continue;

    const v = {...m};
    if (!('보유량' in v)) v['보유량'] = Number(v.have ?? 0);
    if (!('목표량' in v)) v['목표량'] = Number(v.need ?? 0);
    if (isForceNeed1M(name)) v['목표량'] = MILLION;
    delete v.have; delete v.need; delete v.lack; delete v.use;
    outRows.push(v);
  }
  const materialOut = { ...(BASE.materials||{}), materials: outRows };
  pyodide.FS.writeFile('materials.json', JSON.stringify(materialOut), { encoding:'utf8' });
  pyodide.FS.writeFile('event_quests.json', JSON.stringify(BASE.quests), { encoding:'utf8' });
  pyodide.FS.writeFile('event_items.json', JSON.stringify(BASE.items), { encoding:'utf8' });
    }

    // calc_event_eff.py를 그대로 사용
    async function writeCorePyFromFile() {
      const code = await fetch('calc_event_eff.py').then(r=>r.text());
      pyodide.FS.writeFile('calc_event_eff.py', code, { encoding:'utf8' });
    }

    // ===== 4) 실행 =====
    async function runSimulation() {
const out = document.querySelector('#out');
  out.textContent = '실행 중… (브라우저에서 파이썬 코드가 돌아가는 중)';
  document.querySelector('#runBtn').disabled = true;
  try {
    readEditsIntoMaterials();

    const rows = (BASE.materials.materials||[]);
    let totalLack = 0;
    for (const m of rows){
      const name = String(m.item||'');
      if (shouldHide(name) && !(isForceNeed1M(name)||name===NAME_QP)) continue;
      const hv = Number(m['보유량'] ?? 0);
      const nd = Number(m['목표량'] ?? 0);
      const lk = Math.max(nd - hv, 0);
      totalLack += lk;
    }
    if (totalLack <= 0){
      out.textContent = '필요 수량이 0입니다. materials.json에서 목표량을 설정하거나 업로드 후 다시 실행하세요.';
      return;
    }

    const apples = {
      gold:   Number(document.querySelector('#apple-gold').value||0),
      silver: Number(document.querySelector('#apple-silver').value||0),
      blue:   Number(document.querySelector('#apple-blue').value||0),
      copper: Number(document.querySelector('#apple-copper').value||0),
    };

    await writeFiles();
    await writeCorePyFromFile();

    const py = `
import sys, importlib.util
sys.argv = ["calc_event_eff.py",
            "--materials","materials.json",
            "--quests","event_quests.json",
            "--items","event_items.json",
            "--ap-cost","40",
            "--table-format","text",
            "--table-style","ascii",
            "--log","run_log.txt"]
spec = importlib.util.spec_from_file_location("core","calc_event_eff.py")
core = importlib.util.module_from_spec(spec); spec.loader.exec_module(core)

try:
    core.APPLE_COUNTS
except AttributeError:
    core.APPLE_COUNTS = {}
for k,v in ${'__JS_AP__'}.items():
    try:
        core.APPLE_COUNTS[k] = float(v) if v is not None else 0.0
    except Exception:
        core.APPLE_COUNTS[k] = 0.0

core.TABLE_FORMAT = "text"
core.TABLE_STYLE  = "ascii"
core.main()
open("run_log.txt","r",encoding="utf-8").read()
    `.replace('__JS_AP__', JSON.stringify(apples));

    const log = await pyodide.runPythonAsync(py);
    out.textContent = log || '(로그 비어 있음)';
    document.querySelector('#dlBtn').disabled = false;
  } catch (e) {
    out.textContent = '에러 발생: ' + (e && e.message ? e.message : e);
  } finally {
    document.querySelector('#runBtn').disabled = false;
  }
    }

    // ===== 5) 초기화 & 업로드 처리 =====
    async function handleUpload(ev){
const file = ev.target.files && ev.target.files[0];
  if (!file) return;
  try{
    const txt = await file.text();
    const json = JSON.parse(txt);
    if (!json || !Array.isArray(json.materials)) throw new Error('materials 배열이 없습니다.');

    for (const m of (json.materials||[])){
      if (!('보유량' in m) && ('have' in m)) m['보유량'] = Number(m.have||0);
      if (!('목표량' in m) && ('need' in m)) m['목표량'] = Number(m.need||0);
      delete m.have; delete m.need; delete m.lack; delete m.use;
    }

    BASE.materials = json;
    applyHiddenItemPolicies();
    RESET_SNAPSHOT = structuredClone(BASE.materials);
    renderTable(document.querySelector('#search').value||'');

    const tag = document.querySelector('#matUploadName');
    if (tag){ tag.style.display='inline-block'; tag.textContent = file.name; }
  }catch(err){
    alert('materials.json 파싱 실패: ' + err);
  }finally{
    ev.target.value = '';
  }
    }

    (async () => {
      try{
        BASE = await loadJsonFiles();

        // ① 기본 시작: 모든 재료 0으로 세팅한 스냅샷을 활성화
        const zeroed = makeZeroBaseline(BASE.materials);
        BASE.materials = zeroed;
        applyHiddenItemPolicies();
        RESET_SNAPSHOT = structuredClone(BASE.materials); // Reset은 "0으로 세팅된 상태"로

        renderTable();

        await bootPyodide();
        document.querySelector('#boot').innerHTML = '<b class="ok">준비 완료!</b> 사과/아이템 수량을 입력하고 <b>시뮬레이션 실행</b>을 누르세요.';
        document.querySelector('#runBtn').disabled = false;
        document.querySelector('#resetBtn').disabled = false;

        document.querySelector('#dlBtn').addEventListener('click', ()=>{
          const blob = new Blob([document.querySelector('#out').textContent], {type:'text/plain;charset=utf-8'});
          const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'run_log.txt' });
          a.click(); URL.revokeObjectURL(a.href);
        });
        document.querySelector('#runBtn').addEventListener('click', runSimulation);
        document.querySelector('#resetBtn').addEventListener('click', resetInputs);
        document.querySelector('#search').addEventListener('input', (e)=> renderTable(e.target.value||''));
        document.querySelector('#matUpload').addEventListener('change', handleUpload);
      }catch(err){
        document.querySelector('#boot').innerHTML = '<b class="err">초기화 실패:</b> '+err;
      }
    })();
  </script>
</body>
</html>
