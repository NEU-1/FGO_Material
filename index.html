<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>FGO ì´ë²¤íŠ¸ ì£¼íšŒ ì‹œë®¬ë ˆì´í„° â€“ ì›¹ ê°„í¸íŒ (CDN)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --fg:#e5e7eb; --acc:#22d3ee; --ok:#34d399; --err:#f87171 }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,'Noto Sans KR',sans-serif}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    .card{background:#0b1223;border:1px solid #1f2937;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{font-size:22px;margin:0 0 10px} .sub{color:var(--muted);font-size:14px;margin-bottom:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    input[type="number"],input[type="text"]{background:#0b1223;border:1px solid #1f2937;border-radius:10px;color:var(--fg);padding:10px 12px}
    input[type="number"]{width:120px}
    label.sm{font-size:13px;color:var(--muted);display:block;margin-bottom:4px}
    .grp{display:flex;gap:12px;flex-wrap:wrap;margin:6px 0 12px}
    button{background:var(--acc);color:#001018;border:0;border-radius:12px;padding:10px 16px;font-weight:700;cursor:pointer}
    button.ghost{background:#0b1223;color:var(--fg);border:1px solid #1f2937}
    button:disabled{opacity:.6;cursor:not-allowed}
    .hint{color:var(--muted);font-size:13px}
    .tblwrap{max-height:380px;overflow:auto;border:1px solid #1f2937;border-radius:12px}
    table{border-collapse:collapse;width:100%;font-size:14px}
    th,td{border-bottom:1px solid #1f2937;padding:8px 10px;text-align:left}
    thead th{position:sticky;top:0;background:#0b1223;z-index:1}
    pre{white-space:pre-wrap;background:#0b1223;border:1px solid #1f2937;border-radius:12px;padding:16px;min-height:220px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1223;border:1px solid #1f2937;font-size:12px;color:var(--muted)}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .loader{display:inline-block;width:16px;height:16px;border:3px solid #1f2937;border-top-color:var(--acc);border-radius:50%;animation:spin 1s linear infinite;vertical-align:-3px;margin-right:6px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .bar{height:8px;border:1px solid #1f2937;border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,#0891b2,#22d3ee);width:0%}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0 10px}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>FGO ì´ë²¤íŠ¸ ì£¼íšŒ ì‹œë®¬ë ˆì´í„° â€“ ì›¹ ê°„í¸íŒ</h1>
      <div class="sub">
        ì²« ë¡œë”©ì€ ë¸Œë¼ìš°ì €ê°€ íŒŒì´ì¬ì„ ì¤€ë¹„í•˜ëŠë¼ <b>10~25ì´ˆ</b> ê±¸ë¦´ ìˆ˜ ìˆì–´ìš”. ì¤€ë¹„ë˜ë©´ <b>ì‚¬ê³¼ ìˆ˜ëŸ‰</b>ê³¼ <b>ì•„ì´í…œ ìˆ˜ëŸ‰ì˜ í˜„ì¬, ëª©í‘œ</b>ë¥¼ ì…ë ¥í•˜ê³  <b>ì‹¤í–‰</b>ì„ ëˆ„ë¥´ì„¸ìš”.
      </div>

      <!-- ë¶€íŒ… í‘œì‹œ -->
      <div id="boot" class="card" style="padding:14px; margin:10px 0 18px;">
        <div class="row">
          <div class="grow">
            <div><span class="loader"></span><b>Pyodide ë¡œë”© ì¤‘â€¦</b> (ì¸í„°ë„· ì†ë„ì— ë”°ë¼ 10~25ì´ˆ)</div>
            <div class="bar" style="margin-top:10px;"><i id="pbar"></i></div>
            <div class="hint" id="bootmsg">íŒŒì´ì¬ ëŸ°íƒ€ì„ ë‹¤ìš´ë¡œë“œ ì¤‘</div>
          </div>
          <span class="badge">CDN</span>
        </div>
      </div>

      <!-- ì‚¬ê³¼ ì…ë ¥ -->
      <div class="grp">
        <div><label class="sm">ê¸ˆì‚¬ê³¼</label><input id="apple-gold" type="number" min="0" step="1" value="0"></div>
        <div><label class="sm">ì€ì‚¬ê³¼</label><input id="apple-silver" type="number" min="0" step="1" value="0"></div>
        <div><label class="sm">ì²­ì‚¬ê³¼</label><input id="apple-blue" type="number" min="0" step="1" value="0"></div>
        <div><label class="sm">ë™ì‚¬ê³¼</label><input id="apple-copper" type="number" min="0" step="1" value="0"></div>
        <span class="hint">ì‚¬ê³¼ëŠ” ì‹œë®¬ë ˆì´ì…˜ì˜ AP í’€ì„ ì§ì ‘ ê²°ì •í•©ë‹ˆë‹¤.</span>
      </div>

      <!-- ì¬ë£Œ í‘œ -->
      <div class="row" style="margin:12px 0">
        <div class="grow">
          <div class="toolbar">
            <input id="search" type="text" placeholder="ì•„ì´í…œ ê²€ìƒ‰(ì´ë¦„ ì¼ë¶€)" />
          </div>
          <div class="tblwrap">
            <table id="matTable">
              <thead>
                <tr><th>ì¬ë£Œ</th><th>ë ˆì–´ë„</th><th>ap/ê°œ</th><th>ë³´ìœ ëŸ‰</th><th>ëª©í‘œëŸ‰</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="toolbar">
            <button id="runBtn" disabled>ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</button>
            <button id="resetBtn" class="ghost" disabled>ì…ë ¥ê°’ ì´ˆê¸°í™”</button>
            <button id="dlBtn" class="ghost right" disabled>ë¡œê·¸ ë‹¤ìš´ë¡œë“œ</button>
          </div>
        </div>
      </div>

      <pre id="out">ì¶œë ¥ ì¤€ë¹„ ì¤‘â€¦</pre>
    </div>
  </div>

  <script>
    const setP = (pct, msg) => {
      const el = document.querySelector('#pbar'); if(el) el.style.width = pct + '%';
      const m  = document.querySelector('#bootmsg'); if(m && msg) m.textContent = msg;
    };
  </script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"></script>

  <script>
    // ===== 1) JSON ë¡œë“œ =====
    async function loadJsonFiles() {
      const [materials, quests, items] = await Promise.all([
        fetch('materials.json').then(r=>r.json()),
        fetch('event_quests.json').then(r=>r.json()),
        fetch('event_items.json').then(r=>r.json()),
      ]);
      return { materials, quests, items };
    }

    // ===== 2) ì¬ë£Œí‘œ ë Œë”ë§ =====
    let BASE = { materials:null, quests:null, items:null };
    const APPLE_NAMES = ["ê¸ˆì‚¬ê³¼","ì€ì‚¬ê³¼","ì²­ì‚¬ê³¼","ë™ì‚¬ê³¼"];
    const EXCLUDE_ROWS = new Set([...APPLE_NAMES, "í“¨ì–´í”„ë¦¬ì¦˜", "ì¸ì—°", "ì¢…í™”4", "ë¬˜ëª©"]);
    function isExcluded(name){
      if(EXCLUDE_ROWS.has(name)) return true;
      if(name && name.includes("ì¢…í™”")) return true; // ì¢…í™” ì „ì¢… ìˆ¨ê¹€
      return false;
    }

    function renderTable(filter='') {
      const tbody = document.querySelector('#matTable tbody');
      tbody.innerHTML = '';
      const rows = BASE.materials.materials || [];
      const kw = filter.trim();
      for (const m of rows) {
        const rawName = String(m.item||'');
        if (isExcluded(rawName)) continue;
        if (kw && !rawName.includes(kw)) continue;

        const displayName = (rawName === 'QP') ? 'QP(100ë§Œ ë‹¨ìœ„)' : rawName;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${displayName}</td>
          <td>${m.tier??''}</td>
          <td>${(m.ap_per_item??0).toLocaleString(undefined,{maximumFractionDigits:2})}</td>
          <td><input type="number" step="1" value="${m.have??0}" data-name="${rawName}" data-field="have"></td>
          <td><input type="number" step="1" value="${m.need??0}" data-name="${rawName}" data-field="need"></td>
        `;
        tbody.appendChild(tr);
      }
    }

    function initAppleInputsFromMaterials() {
      const rows = BASE.materials.materials || [];
      const map = new Map(rows.map(m=>[String(m.item||''), m]));
      const get = (nm) => Number((map.get(nm)||{}).have||0);
      document.querySelector('#apple-gold').value   = get("ê¸ˆì‚¬ê³¼");
      document.querySelector('#apple-silver').value = get("ì€ì‚¬ê³¼");
      document.querySelector('#apple-blue').value   = get("ì²­ì‚¬ê³¼");
      document.querySelector('#apple-copper').value = get("ë™ì‚¬ê³¼");
    }

    function readEditsIntoMaterialsAndApples() {
      // í‘œ ì…ë ¥ê°’ â†’ materials ë°˜ì˜
      const map = new Map(BASE.materials.materials.map(m=>[String(m.item||''), m]));
      const inputs = document.querySelectorAll('input[data-name]');
      inputs.forEach(inp=>{
        const name  = inp.getAttribute('data-name');
        const field = inp.getAttribute('data-field');
        const row = map.get(name);
        if (!row) return;
        const v = Number(inp.value);
        row[field] = Number.isFinite(v) ? v : 0;
      });

      // ì¸ì—°/ì¢…í™” ëª©í‘œ 100ë§Œ, ìˆ¨ê¸´ ê±´ use='N', ë¶€ì¡± 0
      for (const m of BASE.materials.materials) {
        const name = String(m.item||'');
        if (name.includes('ì¸ì—°') || name.includes('ì¢…í™”')) m.need = 1_000_000;
        if (isExcluded(name)) m.use = 'N';
        const have = Number(m.have||0), need = Number(m.need||0);
        m.lack = isExcluded(name) ? 0 : Math.max(need - have, 0);
      }

      // ì‚¬ê³¼ ê°’ì€ ë³„ë„ ì „ë‹¬
      return {
        gold:   Number(document.querySelector('#apple-gold').value||0),
        silver: Number(document.querySelector('#apple-silver').value||0),
        blue:   Number(document.querySelector('#apple-blue').value||0),
        copper: Number(document.querySelector('#apple-copper').value||0),
      };
    }

    function resetInputs() {
      renderTable(document.querySelector('#search').value||'');
      initAppleInputsFromMaterials();
    }

    // ===== 3) Pyodide ë¶€íŒ… & íŒŒì¼ ì“°ê¸° =====
    let pyodide = null;
    async function bootPyodide() {
      setP(10,'íŒŒì´ì¬ ëŸ°íƒ€ì„ ë‹¤ìš´ë¡œë“œ ì¤‘');
      pyodide = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.26.2/full/' });
      setP(60,'ëŸ°íƒ€ì„ ì´ˆê¸°í™”â€¦'); pyodide.FS.mkdirTree('/'); setP(80,'Python ìŠ¤í¬ë¦½íŠ¸ ì¤€ë¹„â€¦');
    }

    async function writeFiles(applesOverride) {
      pyodide.FS.writeFile('materials.json', JSON.stringify(BASE.materials), { encoding:'utf8' });
      pyodide.FS.writeFile('event_quests.json', JSON.stringify(BASE.quests), { encoding:'utf8' });
      pyodide.FS.writeFile('event_items.json', JSON.stringify(BASE.items), { encoding:'utf8' });
      pyodide.FS.writeFile('apples.json', JSON.stringify(applesOverride), { encoding:'utf8' });
    }

    // ğŸ‘‰ í•µì‹¬ ë³€ê²½: simulator.pyë¥¼ ì™¸ë¶€ íŒŒì¼ì—ì„œ ê·¸ëŒ€ë¡œ ë¶ˆëŸ¬ì™€ FSì— ê¸°ë¡
    async function writeSimulatorPyFromFile() {
      const code = await fetch('simulator.py').then(r=>r.text());
      pyodide.FS.writeFile('simulator.py', code, { encoding:'utf8' });
    }

    // ===== 4) ì‹¤í–‰ =====
    async function runSimulation() {
      const out = document.querySelector('#out');
      out.textContent = 'ì‹¤í–‰ ì¤‘â€¦ (ë¸Œë¼ìš°ì €ì—ì„œ íŒŒì´ì¬ ì½”ë“œê°€ ëŒì•„ê°€ëŠ” ì¤‘)';
      document.querySelector('#runBtn').disabled = true;
      try {
        const apples = readEditsIntoMaterialsAndApples();
        await writeFiles(apples);
        await writeSimulatorPyFromFile();

        const py = `
import sys, json, importlib.util
sys.argv = ["simulator.py",
            "--materials","materials.json",
            "--quests","event_quests.json",
            "--items","event_items.json",
            "--ap-cost","40",
            "--table-format","text",
            "--table-style","ascii",
            "--log","run_log.txt"]

spec = importlib.util.spec_from_file_location("simulator","simulator.py")
simulator = importlib.util.module_from_spec(spec); spec.loader.exec_module(simulator)

with open("apples.json","r",encoding="utf-8") as f:
    apples = json.load(f)
for k in ("gold","silver","blue","copper"):
    if k in apples:
        try: simulator.APPLE_COUNTS[k] = float(apples[k])
        except: simulator.APPLE_COUNTS[k] = 0.0

simulator.TABLE_FORMAT = "text"
simulator.TABLE_STYLE  = "ascii"

simulator.main()
open("run_log.txt","r",encoding="utf-8").read()
        `;
        const log = await pyodide.runPythonAsync(py);
        out.textContent = log || '(ë¡œê·¸ ë¹„ì–´ ìˆìŒ)';
        document.querySelector('#dlBtn').disabled = false;
      } catch (e) {
        out.textContent = 'ì—ëŸ¬ ë°œìƒ: ' + (e && e.message ? e.message : e);
      } finally {
        document.querySelector('#runBtn').disabled = false;
      }
    }

    // ===== 5) ì´ë²¤íŠ¸ ë°”ì¸ë”© & ì´ˆê¸°í™” =====
    (async () => {
      try{
        BASE = await loadJsonFiles();
        renderTable();
        initAppleInputsFromMaterials();
        await bootPyodide();
        document.querySelector('#boot').innerHTML = '<b class="ok">ì¤€ë¹„ ì™„ë£Œ!</b> ì‚¬ê³¼/ì•„ì´í…œ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ê³  <b>ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</b>ì„ ëˆ„ë¥´ì„¸ìš”.';
        document.querySelector('#runBtn').disabled = false;
        document.querySelector('#resetBtn').disabled = false;
        document.querySelector('#dlBtn').addEventListener('click', ()=>{
          const blob = new Blob([document.querySelector('#out').textContent], {type:'text/plain;charset=utf-8'});
          const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'run_log.txt' });
          a.click(); URL.revokeObjectURL(a.href);
        });
        document.querySelector('#runBtn').addEventListener('click', runSimulation);
        document.querySelector('#resetBtn').addEventListener('click', resetInputs);
        document.querySelector('#search').addEventListener('input', (e)=> renderTable(e.target.value||''));
      }catch(err){
        document.querySelector('#boot').innerHTML = '<b class="err">ì´ˆê¸°í™” ì‹¤íŒ¨:</b> '+err;
      }
    })();
  </script>
</body>
</html>
