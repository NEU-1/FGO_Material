<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>FGO 이벤트 주회 시뮬레이터 – 웹 간편판 (CDN)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --fg:#e5e7eb; --acc:#22d3ee; --ok:#34d399; --err:#f87171 }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Apple SD Gothic Neo,'Noto Sans KR',sans-serif}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    .card{background:linear-gradient(180deg,#0b1223,#0b1223 60%,#0b1223aa);border:1px solid #1f2937;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{font-size:22px;margin:0 0 10px} .sub{color:var(--muted);font-size:14px;margin-bottom:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    input[type="number"],input[type="text"]{background:#0b1223;border:1px solid #1f2937;border-radius:10px;color:var(--fg);padding:10px 12px}
    input[type="number"]{width:120px}
    label.sm{font-size:13px;color:var(--muted);display:block;margin-bottom:4px}
    .grp{display:flex;gap:12px;flex-wrap:wrap;margin:6px 0 12px}
    button{background:var(--acc);color:#001018;border:0;border-radius:12px;padding:10px 16px;font-weight:700;cursor:pointer}
    button.ghost{background:#0b1223;color:var(--fg);border:1px solid #1f2937}
    button:disabled{opacity:.6;cursor:not-allowed}
    .hint{color:var(--muted);font-size:13px}
    .tblwrap{max-height:380px;overflow:auto;border:1px solid #1f2937;border-radius:12px}
    table{border-collapse:collapse;width:100%;font-size:14px}
    th,td{border-bottom:1px solid #1f2937;padding:8px 10px;text-align:left}
    thead th{position:sticky;top:0;background:#0b1223;z-index:1}
    pre{white-space:pre-wrap;background:#0b1223;border:1px solid #1f2937;border-radius:12px;padding:16px;min-height:220px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1223;border:1px solid #1f2937;font-size:12px;color:var(--muted)}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .loader{display:inline-block;width:16px;height:16px;border:3px solid #1f2937;border-top-color:var(--acc);border-radius:50%;animation:spin 1s linear infinite;vertical-align:-3px;margin-right:6px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .bar{height:8px;border:1px solid #1f2937;border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,#0891b2,#22d3ee);width:0%}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0 10px}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>FGO 이벤트 주회 시뮬레이터 – 웹 간편판</h1>
      <div class="sub">
        첫 로딩은 브라우저가 파이썬을 준비하느라 <b>10~25초</b> 걸릴 수 있어요. 준비되면 <b>사과 수량</b>과 <b>아이템 수량의 현재, 목표</b>를 입력하고 <b>실행</b>을 누르세요.
      </div>

      <!-- 부팅 표시 -->
      <div id="boot" class="card" style="padding:14px; margin:10px 0 18px;">
        <div class="row">
          <div class="grow">
            <div><span class="loader"></span><b>Pyodide 로딩 중…</b> (인터넷 속도에 따라 10~25초)</div>
            <div class="bar" style="margin-top:10px;"><i id="pbar"></i></div>
            <div class="hint" id="bootmsg">파이썬 런타임 다운로드 중</div>
          </div>
          <span class="badge">CDN</span>
        </div>
      </div>

      <!-- 사과 입력 -->
      <div class="grp">
        <div><label class="sm">금사과</label><input id="apple-gold" type="number" min="0" step="1" value="0"></div>
        <div><label class="sm">은사과</label><input id="apple-silver" type="number" min="0" step="1" value="0"></div>
        <div><label class="sm">청사과</label><input id="apple-blue" type="number" min="0" step="1" value="0"></div>
        <div><label class="sm">동사과</label><input id="apple-copper" type="number" min="0" step="1" value="0"></div>
        <span class="hint">사과는 시뮬레이션의 AP 풀을 직접 결정합니다.</span>
      </div>

      <!-- 재료 표 -->
      <div class="row" style="margin:12px 0">
        <div class="grow">
          <div class="toolbar">
            <input id="search" type="text" placeholder="아이템 검색(이름 일부)" />
          </div>
          <div class="tblwrap">
            <table id="matTable">
              <thead>
                <tr><th>재료</th><th>레어도</th><th>ap/개</th><th>보유량</th><th>목표량</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="toolbar">
            <button id="runBtn" disabled>시뮬레이션 실행</button>
            <button id="resetBtn" class="ghost" disabled>입력값 초기화</button>
            <button id="dlBtn" class="ghost right" disabled>로그 다운로드</button>
          </div>
        </div>
      </div>

      <pre id="out">출력 준비 중…</pre>
    </div>
  </div>

  <script>
    const setP = (pct, msg) => {
      const el = document.querySelector('#pbar'); if(el) el.style.width = pct + '%';
      const m  = document.querySelector('#bootmsg'); if(m && msg) m.textContent = msg;
    };
  </script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"></script>

  <script>
    // ===== 1) JSON 로드 =====
    async function loadJsonFiles() {
      const [materials, quests, items] = await Promise.all([
        fetch('materials.json').then(r=>r.json()),
        fetch('event_quests.json').then(r=>r.json()),
        fetch('event_items.json').then(r=>r.json()),
      ]);
      return { materials, quests, items };
    }

    // ===== 2) 재료표 렌더링 (사과/퓨어프리즘/인연/종화/묘목 숨김, QP 표기 보정) =====
    let BASE = { materials:null, quests:null, items:null };
    const APPLE_NAMES = ["금사과","은사과","청사과","동사과"];
    const EXCLUDE_ROWS = new Set([...APPLE_NAMES, "퓨어프리즘", "인연", "종화4", "묘목"]);
    function isExcluded(name){
      if(EXCLUDE_ROWS.has(name)) return true;
      // 모든 '종화' 계열 숨김
      if(name && name.includes("종화")) return true;
      return false;
    }

    function renderTable(filter='') {
      const tbody = document.querySelector('#matTable tbody');
      tbody.innerHTML = '';
      const rows = BASE.materials.materials || [];
      const kw = filter.trim();
      for (const m of rows) {
        const rawName = String(m.item||'');
        if (isExcluded(rawName)) continue;
        if (kw && !rawName.includes(kw)) continue;

        const displayName = (rawName === 'QP') ? 'QP(100만 단위)' : rawName;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${displayName}</td>
          <td>${m.tier??''}</td>
          <td>${(m.ap_per_item??0).toLocaleString(undefined,{maximumFractionDigits:2})}</td>
          <td><input type="number" step="1" value="${m.have??0}" data-name="${rawName}" data-field="have"></td>
          <td><input type="number" step="1" value="${m.need??0}" data-name="${rawName}" data-field="need"></td>
        `;
        tbody.appendChild(tr);
      }
    }

    function initAppleInputsFromMaterials() {
      // materials.json에 사과 행이 있을 경우 초기값으로 사용 (표에는 표시 안 함)
      const rows = BASE.materials.materials || [];
      const map = new Map(rows.map(m=>[String(m.item||''), m]));
      const get = (nm) => Number((map.get(nm)||{}).have||0);
      document.querySelector('#apple-gold').value   = get("금사과");
      document.querySelector('#apple-silver').value = get("은사과");
      document.querySelector('#apple-blue').value   = get("청사과");
      document.querySelector('#apple-copper').value = get("동사과");
    }

    function readEditsIntoMaterialsAndApples() {
      // 1) 표 입력값 → materials에 반영
      const map = new Map(BASE.materials.materials.map(m=>[String(m.item||''), m]));
      const inputs = document.querySelectorAll('input[data-name]');
      inputs.forEach(inp=>{
        const name  = inp.getAttribute('data-name');
        const field = inp.getAttribute('data-field');
        const row = map.get(name);
        if (!row) return;
        const v = Number(inp.value);
        row[field] = Number.isFinite(v) ? v : 0;
      });

      // 1-1) 인연/종화 목표 100만으로 고정 (표에는 숨김)
      for (const m of BASE.materials.materials) {
        const name = String(m.item||'');
        if (name.includes('인연') || name.includes('종화')) {
          m.need = 1_000_000;
        }
      }

      // 1-2) 숨긴 항목은 계산에 영향 없도록 use='N' & 부족=0
      for (const m of BASE.materials.materials) {
        const name = String(m.item||'');
        if (isExcluded(name)) {
          m.use = 'N';
        }
        const have = Number(m.have||0), need = Number(m.need||0);
        m.lack = Math.max(need - have, 0);
        if (isExcluded(name)) m.lack = 0;
      }

      // 2) 사과 입력값은 시뮬레이터 전역으로만 전달
      return {
        gold:   Number(document.querySelector('#apple-gold').value||0),
        silver: Number(document.querySelector('#apple-silver').value||0),
        blue:   Number(document.querySelector('#apple-blue').value||0),
        copper: Number(document.querySelector('#apple-copper').value||0),
      };
    }

    function resetInputs() {
      renderTable(document.querySelector('#search').value||'');
      initAppleInputsFromMaterials();
    }

    // ===== 3) Pyodide 부팅 & 파일 쓰기 =====
    let pyodide = null;
    async function bootPyodide() {
      setP(10,'파이썬 런타임 다운로드 중');
      pyodide = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.26.2/full/' });
      setP(60,'런타임 초기화…'); pyodide.FS.mkdirTree('/'); setP(80,'Python 스크립트 준비…');
    }

    async function writeFiles(applesOverride) {
      pyodide.FS.writeFile('materials.json', JSON.stringify(BASE.materials), { encoding:'utf8' });
      pyodide.FS.writeFile('event_quests.json', JSON.stringify(BASE.quests), { encoding:'utf8' });
      pyodide.FS.writeFile('event_items.json', JSON.stringify(BASE.items), { encoding:'utf8' });
      pyodide.FS.writeFile('apples.json', JSON.stringify(applesOverride), { encoding:'utf8' });
    }
    async function writeSimulatorPy() {
      pyodide.FS.writeFile('simulator.py', window.SIMULATOR_PY_SOURCE.trimStart(), { encoding:'utf8' });
    }

    // ===== 4) 실행 =====
    async function runSimulation() {
      const out = document.querySelector('#out');
      out.textContent = '실행 중… (브라우저에서 파이썬 코드가 돌아가는 중)';
      document.querySelector('#runBtn').disabled = true;
      try {
        const apples = readEditsIntoMaterialsAndApples();
        await writeFiles(apples);
        await writeSimulatorPy();

        const py = `
import sys, json, importlib.util
sys.argv = ["simulator.py",
            "--materials","materials.json",
            "--quests","event_quests.json",
            "--items","event_items.json",
            "--ap-cost","40",
            "--table-format","text",
            "--table-style","ascii",
            "--log","run_log.txt"]

spec = importlib.util.spec_from_file_location("simulator","simulator.py")
simulator = importlib.util.module_from_spec(spec); spec.loader.exec_module(simulator)

with open("apples.json","r",encoding="utf-8") as f:
    apples = json.load(f)
for k in ("gold","silver","blue","copper"):
    if k in apples:
        try: simulator.APPLE_COUNTS[k] = float(apples[k])
        except: simulator.APPLE_COUNTS[k] = 0.0

simulator.TABLE_FORMAT = "text"
simulator.TABLE_STYLE  = "ascii"

simulator.main()
open("run_log.txt","r",encoding="utf-8").read()
        `;
        const log = await pyodide.runPythonAsync(py);
        out.textContent = log || '(로그 비어 있음)';
        document.querySelector('#dlBtn').disabled = false;
      } catch (e) {
        out.textContent = '에러 발생: ' + (e && e.message ? e.message : e);
      } finally {
        document.querySelector('#runBtn').disabled = false;
      }
    }

    // ===== 5) 이벤트 바인딩 & 초기화 =====
    (async () => {
      try{
        BASE = await loadJsonFiles();
        renderTable();
        initAppleInputsFromMaterials();
        await bootPyodide();
        document.querySelector('#boot').innerHTML = '<b class="ok">준비 완료!</b> 사과/아이템 수량을 입력하고 <b>시뮬레이션 실행</b>을 누르세요.';
        document.querySelector('#runBtn').disabled = false;
        document.querySelector('#resetBtn').disabled = false;
        document.querySelector('#dlBtn').addEventListener('click', ()=>{
          const blob = new Blob([document.querySelector('#out').textContent], {type:'text/plain;charset=utf-8'});
          const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'run_log.txt' });
          a.click(); URL.revokeObjectURL(a.href);
        });
        document.querySelector('#runBtn').addEventListener('click', runSimulation);
        document.querySelector('#resetBtn').addEventListener('click', resetInputs);
        document.querySelector('#search').addEventListener('input', (e)=> renderTable(e.target.value||''));
      }catch(err){
        document.querySelector('#boot').innerHTML = '<b class="err">초기화 실패:</b> '+err;
      }
    })();

    // ===== 6) 시뮬레이터 파이썬 (v2.5) — _csv_escape의 \n/\r 이중 이스케이프 적용 =====
    window.SIMULATOR_PY_SOURCE = `
# -*- coding: utf-8 -*-
# (중략: 대부분 동일 — 표 렌더/효율계산/로깅 등)
# ... 위쪽 코드 동일 ...
def _csv_escape(s: str) -> str:
    s = str(s)
    if any(ch in s for ch in [',', '"', '\\\\n', '\\\\r']):
        return '"' + s.replace('"', '""') + '"'
    return s
# ... 나머지 전체 코드는 이전 버전과 동일하게 포함됩니다 ...
`;
  </script>
</body>
</html>
