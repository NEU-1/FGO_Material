<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>FGO ì´ë²¤íŠ¸ ì£¼íšŒ ì‹œë®¬ë ˆì´í„° â€“ ì›¹ ê°„í¸íŒ (CDN)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root{--bg:#0f172a;--card:#0b1223;--muted:#94a3b8;--fg:#e5e7eb;--acc:#22d3ee;--ok:#34d399;--err:#f87171}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,'Noto Sans KR',sans-serif}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    .card{background:linear-gradient(180deg,#0b1223,#0b1223 60%,#0c1427);border:1px solid #1f2937;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{font-size:22px;margin:0 0 6px}
    .sub{color:var(--muted);font-size:13px;margin:0 0 18px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    input[type="number"],input[type="text"],input[type="file"]{background:#0b1223;border:1px solid #1f2937;border-radius:10px;color:var(--fg);padding:10px 12px}
    input[type="number"]{width:140px}
    input::placeholder{color:#64748b}
    button{background:#0b1223;border:1px solid #1f2937;border-radius:10px;color:var(--fg);padding:10px 12px;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .btn-primary{background:linear-gradient(90deg,#0891b2,#22d3ee);border-color:transparent;color:#001b2a}
    .btn-ghost{background:transparent}
    .hint{color:var(--muted);font-size:12px}
    .bar{height:6px;background:#111827;border-radius:999px;overflow:hidden}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#22d3ee,#06b6d4);width:0;transition:width .2s}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:#0b1223;border:1px solid #1f2937;font-size:12px;color:var(--muted)}
    .xbtn{background:transparent;border:none;color:var(--muted);font-weight:700;cursor:pointer}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{border-bottom:1px solid #1f2937;padding:8px 10px;text-align:left}
    thead th{position:sticky;top:0;background:#0b1223;z-index:1}
    pre{white-space:pre-wrap;background:#0b1223;border:1px solid #1f2937;border-radius:12px;padding:16px;min-height:220px}
    .grp input{min-width:120px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #1f2937;color:#cbd5e1;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>FGO ì´ë²¤íŠ¸ ì£¼íšŒ ì‹œë®¬ë ˆì´í„°</h1>
    <div class="sub">ë¸Œë¼ìš°ì €ì—ì„œ íŒŒì´ì¬ì„ ì‹¤í–‰í•´ ì´ë²¤íŠ¸ íš¨ìœ¨ì„ ê³„ì‚°í•©ë‹ˆë‹¤. <span class="pill">CDN</span></div>

    <!-- ë¶€íŒ… í‘œì‹œ -->
    <div id="boot" class="card" style="padding:14px; margin:10px 0 18px;">
      <div class="row">
        <div class="grow">
          <div><b>Pyodide ë¡œë”© ì¤‘â€¦</b> <span class="hint">(ì¸í„°ë„· ì†ë„ì— ë”°ë¼ 10~25ì´ˆ)</span></div>
          <div class="bar" style="margin-top:10px;"><i id="pbar"></i></div>
          <div class="hint" id="bootmsg">íŒŒì´ì¬ ëŸ°íƒ€ì„ ë‹¤ìš´ë¡œë“œ ì¤‘</div>
        </div>
      </div>
    </div>

    <!-- ì‚¬ê³¼ ì…ë ¥ -->
    <div class="card" id="applesCard">
      <div class="row" style="align-items:flex-end">
        <div><label class="sm">ê¸ˆì‚¬ê³¼</label><input id="apple-gold" type="number" min="0" step="1" placeholder="0"></div>
        <div><label class="sm">ì€ì‚¬ê³¼</label><input id="apple-silver" type="number" min="0" step="1" placeholder="0"></div>
        <div><label class="sm">ì²­ì‚¬ê³¼</label><input id="apple-blue" type="number" min="0" step="1" placeholder="0"></div>
        <div><label class="sm">ë™ì‚¬ê³¼</label><input id="apple-copper" type="number" min="0" step="1" placeholder="0"></div>
        <div class="hint" style="margin-left:auto">* ìˆ˜ëŸ‰ì€ ê°œìˆ˜, íšŒë³µëŸ‰ì€ APì…ë‹ˆë‹¤.</div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label class="sm">ê¸ˆì‚¬ê³¼ AP íšŒë³µëŸ‰</label><input id="ap-gold" type="number" min="1" step="1" placeholder="146"></div>
        <div><label class="sm">ì€ì‚¬ê³¼ AP íšŒë³µëŸ‰</label><input id="ap-silver" type="number" min="1" step="1" placeholder="73"></div>
        <div><label class="sm">ì²­ì‚¬ê³¼ AP íšŒë³µëŸ‰</label><input id="ap-blue" type="number" min="1" step="1" placeholder="40"></div>
        <div><label class="sm">ë™ì‚¬ê³¼ AP íšŒë³µëŸ‰</label><input id="ap-copper" type="number" min="1" step="1" placeholder="10"></div>
      </div>
    </div>

    <!-- ì¬ë£Œ í‘œ/ê²€ìƒ‰/ì—…ë¡œë“œ -->
    <div class="card">
      <div class="row" id="uploadRow">
        <input id="search" class="grow" placeholder="ì¬ë£Œ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰ (ì˜ˆ: ë‹¨ì²™, ì¸ì—°, QP)">
        <div class="hint">í…Œì´ë¸” í—¤ë”ëŠ” í•œêµ­ì–´ ê³ ì • (ë³´ìœ ëŸ‰/ëª©í‘œëŸ‰). QPëŠ” 100ë§Œ ë‹¨ìœ„, ì¸ì—°ì€ 1,000 ë‹¨ìœ„ í‘œê¸°.</div>
      </div>
      <div class="row" id="uploadRow2" style="margin-top:8px">
        <div class="grow hint">ê¸°ë³¸ì€ ëª¨ë“  ì¬ë£Œ <b>0</b>ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤. í•„ìš”í•˜ë©´ <b>materials.json</b> ë˜ëŠ” <b>chaldea-userdata.json</b>ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</div>
        <label class="sm" style="margin:0">ë°ì´í„° ì—…ë¡œë“œ</label>
        <input id="matUpload" type="file" accept="application/json" />
        <span id="fileBadge" class="badge" style="display:none"></span>
      </div>

      <div class="tblwrap" style="margin-top:10px">
        <table id="matTable">
          <thead><tr><th>ì¬ë£Œ</th><th>ë ˆì–´ë„</th><th>ap/ê°œ</th><th>ë³´ìœ ëŸ‰</th><th>ëª©í‘œëŸ‰</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- ì‹¤í–‰ ì˜ì—­ -->
    <div class="row" style="margin-top:16px">
      <button id="runBtn" class="btn-primary" disabled>ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</button>
      <button id="resetBtn" class="btn-ghost">ì…ë ¥ ì´ˆê¸°í™”</button>
      <button id="dlBtn" class="btn-ghost" disabled>ë¡œê·¸ ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <pre id="out" class="card" style="margin-top:12px">Pyodide ì¤€ë¹„ ì¤‘â€¦</pre>
  </div>

  <script>
    const setP = (pct, msg) => {
      const el = document.querySelector('#pbar'); if(el) el.style.width = pct + '%';
      const m  = document.querySelector('#bootmsg'); if(m && msg) m.textContent = msg;
    };
  </script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js" crossorigin="anonymous"></script>

  <script>
    // ===== 1) JSON ë¡œë“œ =====
    async function loadJsonFiles() {
      const [materials, quests, items] = await Promise.all([
        fetch('materials.json').then(r=>r.json()),
        fetch('event_quests.json').then(r=>r.json()),
        fetch('event_items.json').then(r=>r.json()),
      ]);
      return { materials, quests, items };
    }

    // ===== 2) í‘œ ë Œë”ë§ & í¸ì§‘ìˆ˜ì§‘ =====
    let BASE = { materials:null, quests:null, items:null };
    let ZERO_BASELINE = null; // 0ìœ¼ë¡œ ì´ˆê¸°í™”ëœ ìŠ¤ëƒ…ìƒ·
    const HIDE_BY_KEYWORD = ['ì‚¬ê³¼','í“¨ì–´','í”„ë¦¬ì¦˜','ì¸ì—°','ì¢…í™”','ë¬˜ëª©'];
    const EXACT_HIDE = new Set(['ê¸ˆì‚¬ê³¼','ì€ì‚¬ê³¼','ì²­ì‚¬ê³¼','ë™ì‚¬ê³¼','í“¨ì–´í”„ë¦¬ì¦˜','ë¬˜ëª©']);
    const FORCE_NEED_1M_KEYWORD = ['ì¸ì—°','ì¢…í™”'];
    const NAME_QP = 'QP';
    const MILLION = 1_000_000;

    function shouldHide(name){
      if (EXACT_HIDE.has(name)) return true;
      return HIDE_BY_KEYWORD.some(k => name.includes(k));
    }
    function isForceNeed1M(name){ return FORCE_NEED_1M_KEYWORD.some(k=>name.includes(k)); }

    function labelFor(name){
      if (name === NAME_QP) return 'QP (100ë§Œ ë‹¨ìœ„)';
      if (name.includes('ì¸ì—°')) return name + ' (1,000 ë‹¨ìœ„)';
      return name;
    }

    function makeZeroBaseline(materialsJson){
      const out = structuredClone(materialsJson);
      for (const m of (out.materials||[])){
        m.have = 0; m.need = 0; m.lack = 0;
      }
      return out;
    }

    function applyHiddenItemPolicies(){
      const rows = BASE.materials.materials || [];
      for (const m of rows){
        const name = String(m.item||'');
        if (shouldHide(name) && !isForceNeed1M(name) && name !== NAME_QP){
          m.use = 'N';
        }
        if (isForceNeed1M(name)){
          m.need = MILLION;
          m.lack = Math.max((m.need||0)-(m.have||0),0);
          m.use = 'Y';
        }
      }
    }

    function renderTable(filter='') {
      const tbody = document.querySelector('#matTable tbody');
      tbody.innerHTML = '';
      const rows = BASE.materials.materials || [];
      const kw = (filter||'').trim();
      for (const m of rows) {
        const rawName = String(m.item||'');
        if (shouldHide(rawName)) continue;
        if (kw && !rawName.includes(kw)) continue;

        const isQP = (rawName === NAME_QP);
        const dispHave = isQP ? Math.floor((m.have||0)/MILLION) : (m.have??0);
        const dispNeed = isQP ? Math.floor((m.need||0)/MILLION) : (m.need??0);

        const haveAttr = (dispHave && dispHave!==0) ? `value="${dispHave}"` : '';
        const needAttr = (dispNeed && dispNeed!==0) ? `value="${dispNeed}"` : '';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${labelFor(rawName)}</td>
          <td>${m.tier??''}</td>
          <td>${(m.ap_per_item??0).toLocaleString(undefined,{maximumFractionDigits:2})}</td>
          <td><input type="number" min="0" step="1" placeholder="0" ${haveAttr} data-name="${rawName}" data-field="have" ${isForceNeed1M(rawName)?'disabled':''}></td>
          <td><input type="number" min="0" step="1" placeholder="0" ${needAttr} data-name="${rawName}" data-field="need" ${isForceNeed1M(rawName)?'disabled':''}></td>
        `;
        tbody.appendChild(tr);
      }
    }

    function readEditsIntoMaterials() {
      const map = new Map(BASE.materials.materials.map(m=>[String(m.item||''), m]));
      const inputs = document.querySelectorAll('input[data-name]');
      inputs.forEach(inp=>{
        const name  = inp.getAttribute('data-name');
        const field = inp.getAttribute('data-field');
        const row = map.get(name);
        if (!row) return;
        let v = Number(inp.value);
        if (!Number.isFinite(v)) v = 0;
        if (name === NAME_QP) v = v * MILLION; // QPëŠ” 100ë§Œ ë‹¨ìœ„ ì…ë ¥
        row[field] = v;
      });
      for (const m of BASE.materials.materials) {
        const have = Number(m.have||0), need = Number(m.need||0);
        m.lack = Math.max(need - have, 0);
      }
    }

    // ===== 3) Pyodide ë¶€íŒ… & íŒŒì¼ ì“°ê¸° =====
    let pyodide = null;
    async function bootPyodide() {
      setP(10,'íŒŒì´ì¬ ëŸ°íƒ€ì„ ë‹¤ìš´ë¡œë“œ ì¤‘');
      pyodide = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.26.2/full/' });
      setP(60,'ëŸ°íƒ€ì„ ì´ˆê¸°í™”â€¦');
      pyodide.FS.mkdirTree('/');
      setP(80,'Python ìŠ¤í¬ë¦½íŠ¸ ì¤€ë¹„â€¦');
    }

    async function writeFiles() {
      pyodide.FS.writeFile('materials.json', JSON.stringify(BASE.materials), { encoding:'utf8' });
      pyodide.FS.writeFile('event_quests.json', JSON.stringify(BASE.quests), { encoding:'utf8' });
      pyodide.FS.writeFile('event_items.json', JSON.stringify(BASE.items), { encoding:'utf8' });
    }

    async function writeCorePyFromFile() {
      const code = await fetch('calc_event_eff.py').then(r=>r.text());
      pyodide.FS.writeFile('calc_event_eff.py', code, { encoding:'utf8' });
    }

    // ===== 4) ì‹¤í–‰ =====
    async function runSimulation() {
      const out = document.querySelector('#out');
      out.textContent = 'ì‹¤í–‰ ì¤‘â€¦ (ë¸Œë¼ìš°ì €ì—ì„œ íŒŒì´ì¬ ì½”ë“œê°€ ëŒì•„ê°€ëŠ” ì¤‘)';
      document.querySelector('#runBtn').disabled = true;
      try {
        // í‘œ ì…ë ¥ ë°˜ì˜
        readEditsIntoMaterials();

        // ì‚¬ê³¼ ìˆ˜ëŸ‰
        const apples = {
          gold:   Number(document.querySelector('#apple-gold').value||0),
          silver: Number(document.querySelector('#apple-silver').value||0),
          blue:   Number(document.querySelector('#apple-blue').value||0),
          copper: Number(document.querySelector('#apple-copper').value||0),
        };
        // ì‚¬ê³¼ AP íšŒë³µëŸ‰ (ê¸°ë³¸ê°’: ê¸ˆ 146, ì€ 73, ì²­ 40, ë™ 10)
        const appleAp = {
          gold:   Number(document.querySelector('#ap-gold').value||146),
          silver: Number(document.querySelector('#ap-silver').value||73),
          blue:   Number(document.querySelector('#ap-blue').value||40),
          copper: Number(document.querySelector('#ap-copper').value||10),
        };

        await writeFiles();
        await writeCorePyFromFile();

        // íŒŒì´ì¬ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ êµ¬ì„±
        const py = `
import importlib.util, json, sys, io, os
sys.stdout = open("run_log.txt","w",encoding="utf-8")

# ëª¨ë“ˆ ë¡œë“œ
spec = importlib.util.spec_from_file_location("core","calc_event_eff.py")
core = importlib.util.module_from_spec(spec); spec.loader.exec_module(core)

# ì‚¬ê³¼ ìˆ˜ëŸ‰ ì£¼ì…
try:
    core.APPLE_COUNTS
except AttributeError:
    core.APPLE_COUNTS = {}
for k,v in ${JSON.stringify({gold:0,silver:0,blue:0,copper:0})}.items():
    pass
for k,v in __JS_AP__.items():
    try:
        core.APPLE_COUNTS[k] = float(v) if v is not None else 0.0
    except Exception:
        core.APPLE_COUNTS[k] = 0.0

# ì‚¬ê³¼ AP íšŒë³µëŸ‰ ì£¼ì…
try:
    core.APPLE_AP_BY_POOL
except AttributeError:
    core.APPLE_AP_BY_POOL = {}
for k,v in ${JSON.stringify({gold:146,silver:73,blue:40,copper:10})}.items():
    pass
for k,v in __JS_APPLE_AP__.items():
    try:
        core.APPLE_AP_BY_POOL[k] = float(v) if v is not None else core.APPLE_AP_BY_POOL.get(k,0.0)
    except Exception:
        pass

core.TABLE_FORMAT = "text"
core.TABLE_STYLE  = "ascii"

core.main()
open("run_log.txt","r",encoding="utf-8").read()
        `.replace('__JS_APPLE_AP__', JSON.stringify(appleAp))
         .replace('__JS_AP__', JSON.stringify(apples));

        const log = await pyodide.runPythonAsync(py);
        out.textContent = log || '(ë¡œê·¸ ë¹„ì–´ ìˆìŒ)';
        document.querySelector('#dlBtn').disabled = false;
      } catch (e) {
        out.textContent = 'ì—ëŸ¬ ë°œìƒ: ' + (e && e.message ? e.message : e);
      } finally {
        document.querySelector('#runBtn').disabled = false;
      }
    }

    // ===== 5) ì—…ë¡œë“œ ì²˜ë¦¬ =====
    function showFileBadge(name, kind, applied){
      const b = document.querySelector('#fileBadge');
      if (!b) return;
      b.style.display = 'inline-flex';
      b.innerHTML = `ğŸ“„ ${name} <button type="button" class="xbtn" id="clearFile">Ã—</button>` + (applied? ` <span class="hint">${applied}ê°œ ì ìš©</span>` : '');
      const x = document.querySelector('#clearFile');
      x.onclick = ()=>{ b.style.display='none'; b.textContent=''; BASE.materials = structuredClone(ZERO_BASELINE); applyHiddenItemPolicies(); renderTable(document.querySelector('#search').value||''); };
    }

    async function handleUpload(ev){
      const file = ev.target.files && ev.target.files[0];
      if (!file) return;
      try{
        const txt = await file.text();
        const json = JSON.parse(txt);

        // materials.json
        if (json && Array.isArray(json.materials)) {
          BASE.materials = json;
          applyHiddenItemPolicies();
          renderTable(document.querySelector('#search').value||'');
          showFileBadge(file.name, 'materials');
          return;
        }

        // chaldea-userdata.json
        if (json && json.users) {
          const user = Array.isArray(json.users) ? json.users[0] : json.users;
          const haveMap = (user && user.items) || {};
          const lackMap = ((user && user.freeLPParams && user.freeLPParams.planItemCounts) || {});
          let applied = 0;
          const rows = BASE.materials.materials || [];
          for (const m of rows) {
            const id = m.id != null ? String(m.id) : null;
            if (!id) continue;
            const have = Number(haveMap[id] || 0);
            const lack = Number(lackMap[id] || 0);
            m.have = Number.isFinite(have) ? have : 0;
            const goal = m.have + (Number.isFinite(lack) ? lack : 0);
            m.need = goal;
            m.lack = Math.max(goal - m.have, 0);
            applied++;
          }
          applyHiddenItemPolicies();
          renderTable(document.querySelector('#search').value||'');
          showFileBadge(file.name, 'chaldea', applied);
          return;
        }

        alert('ì•Œ ìˆ˜ ì—†ëŠ” JSON í˜•ì‹ì…ë‹ˆë‹¤. materials.json ë˜ëŠ” chaldea-userdata.jsonì„ ì˜¬ë ¤ì£¼ì„¸ìš”.');
      }catch(err){
        alert('ì—…ë¡œë“œ íŒŒì‹± ì‹¤íŒ¨: ' + err);
      }finally{
        ev.target.value = '';
      }
    }

    // ===== 6) ë¶€íŒ… =====
    (async () => {
      try{
        BASE = await loadJsonFiles();

        // 0ìœ¼ë¡œ ì´ˆê¸°í™”ëœ ê°’ìœ¼ë¡œ ì‹œì‘
        ZERO_BASELINE = makeZeroBaseline(BASE.materials);
        BASE.materials = structuredClone(ZERO_BASELINE);
        applyHiddenItemPolicies();
        renderTable();

        await bootPyodide();
        document.querySelector('#boot').innerHTML = '<b class="ok">ì¤€ë¹„ ì™„ë£Œ!</b> ì‚¬ê³¼/ì•„ì´í…œ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ê³  <b>ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</b>ì„ ëˆ„ë¥´ì„¸ìš”.';
        document.querySelector('#runBtn').disabled = false;

        // ì´ë²¤íŠ¸
        document.querySelector('#runBtn').addEventListener('click', runSimulation);
        document.querySelector('#resetBtn').addEventListener('click', ()=>{
          BASE.materials = structuredClone(ZERO_BASELINE);
          applyHiddenItemPolicies();
          renderTable(document.querySelector('#search').value||'');
          for (const id of ['apple-gold','apple-silver','apple-blue','apple-copper','ap-gold','ap-silver','ap-blue','ap-copper']){
            const el = document.getElementById(id); if (el) el.value='';
          }
        });
        document.querySelector('#dlBtn').addEventListener('click', ()=>{
          const blob = new Blob([document.querySelector('#out').textContent||''], {type:'text/plain;charset=utf-8'});
          const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'run_log.txt' });
          a.click(); URL.revokeObjectURL(a.href);
        });
        document.querySelector('#search').addEventListener('input', (e)=> renderTable(e.target.value||''));
        document.querySelector('#matUpload').addEventListener('change', handleUpload);
      }catch(err){
        document.querySelector('#boot').innerHTML = '<b class="err">ì´ˆê¸°í™” ì‹¤íŒ¨:</b> '+err;
      }
    })();
  </script>
</body>
</html>
