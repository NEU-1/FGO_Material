<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>FGO 이벤트 주회 시뮬레이터 – 웹 간편판 (CDN)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root{--bg:#0f172a;--card:#0b1223;--muted:#94a3b8;--fg:#e5e7eb;--acc:#22d3ee;--ok:#34d399;--err:#f87171}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Inter,'Noto Sans KR',sans-serif}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    .card{background:linear-gradient(180deg,#0b1223,#0b1223 60%,rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{font-size:22px;margin:0 0 10px}.sub{color:var(--muted);font-size:14px;margin-bottom:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}.grow{flex:1}
    input[type="number"],input[type="text"],input[type="file"]{background:#0a1020;border:1px solid rgba(255,255,255,.08);border-radius:10px;color:var(--fg);padding:9px 12px;outline:none}
    input[type="number"],input[type="text"]{min-width:90px}
    label.sm{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .grp{display:flex;gap:12px;flex-wrap:wrap}
    .toolbar{display:flex;gap:10px;align-items:center}
    .toolbar .hint{color:var(--muted);font-size:13px}
    button{background:#141c2f;color:var(--fg);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:9px 12px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    button#runBtn{background:linear-gradient(90deg,#1e293b,#111827)}
    .ok{color:var(--ok)}.err{color:var(--err)}
    .loader{display:inline-block;width:12px;height:12px;border:2px solid rgba(255,255,255,.35);border-top-color:transparent;border-radius:50%;margin-right:6px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .bar{height:6px;border-radius:99px;background:#0b1120;overflow:hidden;border:1px solid rgba(255,255,255,.08)}
    .bar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#22d3ee,#34d399)}
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    thead th{position:sticky;top:0;background:#0b1223;padding:8px;border-bottom:1px solid rgba(255,255,255,.08)}
    tbody td{background:#0b1223;padding:8px;border:1px solid rgba(255,255,255,.06)}
    tbody tr td:first-child{border-radius:12px 0 0 12px}
    tbody tr td:last-child{border-radius:0 12px 12px 0}
    .tblwrap{max-height:460px;overflow:auto;border-radius:12px;border:1px solid rgba(255,255,255,.06)}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#0a1020;border:1px solid rgba(255,255,255,.08);color:#cbd5e1;padding:6px 10px;border-radius:999px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>FGO 이벤트 주회 시뮬레이터</h1>
      <div class="sub">첫 로딩은 브라우저가 파이썬을 준비하느라 <b>10~25초</b> 걸릴 수 있어요. 준비되면 <b>사과 수량</b>과 <b>아이템 수량의 현재/목표</b>를 입력하고 <b>실행</b>을 누르세요.</div>

      <!-- 부팅 표시 -->
      <div id="boot" class="card" style="padding:14px; margin:10px 0 18px;">
        <div class="row">
          <div class="grow">
            <div><span class="loader"></span><b>Pyodide 로딩 중…</b> (인터넷 속도에 따라 10~25초)</div>
            <div class="bar" style="margin-top:10px;"><i id="pbar"></i></div>
            <div class="hint" id="bootmsg">파이썬 런타임 다운로드 중</div>
          </div>
          <span class="badge">CDN</span>
        </div>
      </div>

      <!-- 사과 입력 -->
      <div class="grp">
        <div><label class="sm">금사과</label><input id="apple-gold" type="number" min="0" step="1" value="0"></div>
        <div><label class="sm">은사과</label><input id="apple-silver" type="number" min="0" step="1" value="0"></div>
        <div><label class="sm">청사과</label><input id="apple-blue" type="number" min="0" step="1" value="0"></div>
        <div><label class="sm">동사과</label><input id="apple-copper" type="number" min="0" step="1" value="0"></div>
      </div>

      <!-- 재료 표/검색/업로드 -->
      <div class="row" style="margin:12px 0">
        <div class="grow">
          <div class="toolbar">
            <input id="search" type="text" placeholder="아이템 검색(이름 일부)" />
            <span class="grow hint">기본은 모든 재료 <b>0</b>으로 시작합니다. 필요하면 아래에서 <b>JSON 업로드 (materials.json 또는 Chaldea userdata)</b>로 교체하세요.</span>
            <label class="sm" style="margin:0">JSON 업로드 (materials.json 또는 Chaldea userdata)</label>
            <input id="matUpload" type="file" accept="application/json" />
          </div>

          <div class="tblwrap">
            <table id="matTable">
              <thead><tr><th>재료</th><th>레어도</th><th>ap/개</th><th>보유량</th><th>목표량</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="toolbar">
            <button id="runBtn" disabled>시뮬레이션 실행</button>
            <button id="dlBtn" disabled>로그 저장</button>
            <button id="resetBtn" disabled>입력 리셋</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <pre id="out" style="white-space:pre-wrap; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace"></pre>
      </div>
    </div>
  </div>

  <script>
    const setP = (pct, msg) => {
      const el = document.querySelector('#pbar'); if(el) el.style.width = pct + '%';
      const m  = document.querySelector('#bootmsg'); if(m && msg) m.textContent = msg;
    };
  </script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"></script>

  <script>
    // ===== 1) JSON 로드 =====
    async function loadJsonFiles() {
      const [materials, quests, items] = await Promise.all([
        fetch('materials.json').then(r=>r.json()),
        fetch('event_quests.json').then(r=>r.json()),
        fetch('event_items.json').then(r=>r.json()),
      ]);
      return {materials, quests, items};
    }

    // ===== 2) 재료 표 렌더링(사과/특정 항목 숨김 & QP 100만 단위 표기) =====
    let BASE = { materials:null, quests:null, items:null };

    const HIDE_BY_KEYWORD = ['사과','퓨어','프리즘','인연','종화','묘목']; // 포함시 숨김
    const EXACT_HIDE = new Set(['금사과','은사과','청사과','동사과','퓨어프리즘','묘목']); // 정확히 숨김
    const FORCE_NEED_1M_KEYWORD = ['인연','종화']; // 목표 100만 강제
    const NAME_QP = 'QP';
    const MILLION = 1_000_000;

    // 업로드/리셋 기준 스냅샷(Reset 버튼 동작용)
    let RESET_SNAPSHOT = null;
    // Apple touched flags (to respect user edits)
    const APPLE_TOUCHED = { gold:false, silver:false, blue:false, copper:false };
    ['gold','silver','blue','copper'].forEach(k=>{
      const el = document.querySelector('#apple-'+k);
      if (el) el.addEventListener('input', ()=> APPLE_TOUCHED[k] = true);
    });

    function applyApplesFromMaterials(matJson){
      const rows = (matJson && matJson.materials) || [];
      const byName = new Map(rows.map(m=>[m.item, m]));
      const mapping = [
        ['gold','금사과'],
        ['silver','은사과'],
        ['blue','청사과'],
        ['copper','동사과'],
      ];
      for (const [key, name] of mapping){
        const row = byName.get(name);
        if (!row) continue;
        const val = Number(row.have||0);
        const el = document.querySelector('#apple-'+key);
        if (!el) continue;
        if (!APPLE_TOUCHED[key]) el.value = String(val||0);
      }
    }

    function shouldHide(name){
      if (EXACT_HIDE.has(name)) return true;
      return HIDE_BY_KEYWORD.some(k => name.includes(k));
    }
    function isForceNeed1M(name){
      return FORCE_NEED_1M_KEYWORD.some(k => name.includes(k));
    }
    function labelFor(name){
      if (name === NAME_QP) return 'QP(100만 단위)';
      return name;
    }

    function applyChaldeaUserdata(json){
      try{
        const user = (json.users && json.users[0]) || {};
        const inv  = (user.items) || {};
        const needMap = (user.freeLPParams && user.freeLPParams.planItemCounts) || {};
        const out = structuredClone(BASE.materials);
        const rows = out.materials || [];
        // reset to zero baseline
        for (const m of rows){ m.have=0; m.lack=0; m.need=0; }
        const byId = new Map(rows.map(m=>[String(m.id ?? m.item_id ?? ''), m]));
        let mapped = 0;
        for (const idStr of Object.keys(inv)){
          const r = byId.get(String(idStr));
          if (!r) continue;
          const have = Number(inv[idStr]||0);
          const lack = Number(needMap[idStr]||0);
          r.have = have;
          r.lack = lack;
          r.need = have + lack; // 목표 = 보유 + 부족
          mapped++;
        }
        BASE.materials = out;
        applyHiddenItemPolicies();
        RESET_SNAPSHOT = structuredClone(BASE.materials);
        renderTable(document.querySelector('#search').value||'');
        if (mapped === 0){
          alert('Chaldea 파일을 읽었지만 materials.json에 아이템 id가 없어 매핑할 수 없습니다. id 필드가 포함된 materials.json을 사용해주세요.');
        }
      }catch(e){
        alert('Chaldea userdata 처리 실패: '+ e);
      }
    }

    // 업로드하지 않은 기본 시작: 모든 have/need 0으로 초기화
    function makeZeroBaseline(materialsJson){
      const out = structuredClone(materialsJson);
      for (const m of (out.materials||[])){
        m.have = 0;
        // QP/인연/종화는 필요시 별도 처리
        if (isForceNeed1M(m.item)) m.need = MILLION;
        else m.need = 0;
        m.lack = Math.max(0, (m.need||0) - (m.have||0));
      }
      return out;
    }

    function applyHiddenItemPolicies(){
      for (const m of (BASE.materials.materials||[])){
        // 인연/종화는 목표를 100만으로 고정(표시는 1000단위·100만 단위 처리)
        if (isForceNeed1M(m.item)){
          m.need = MILLION;
          m.lack = Math.max(0, MILLION - (m.have||0));
        }
      }
    }

    function renderTable(keyword=''){
      const tbody = document.querySelector('#matTable tbody'); tbody.innerHTML='';
      const rows = (BASE.materials.materials||[]).filter(m=>!shouldHide(m.item));
      const q = (keyword||'').trim();
      const filtered = q ? rows.filter(m=>m.item.includes(q)) : rows;
      for (const m of filtered){
        const rawName = m.item;
        const dispHave = rawName===NAME_QP? (m.have||0)/MILLION : (m.have||0);
        const dispNeed = rawName===NAME_QP? (m.need||0)/MILLION : (m.need||0);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${labelFor(rawName)}</td>
          <td>${m.tier??''}</td>
          <td>${(m.ap_per_item??0).toLocaleString(undefined,{maximumFractionDigits:2})}</td>
          <td><input type="number" step="1" value="${dispHave}" data-name="${rawName}" data-field="have" ${isForceNeed1M(rawName)?'disabled':''}></td>
          <td><input type="number" step="1" value="${dispNeed}" data-name="${rawName}" data-field="need" ${isForceNeed1M(rawName)?'disabled':''}></td>
        `;
        tbody.appendChild(tr);
      }
    }

    function readEditsIntoMaterials() {
      const map = new Map(BASE.materials.materials.map(m=>[String(m.item||''), m]));
      const inputs = document.querySelectorAll('input[data-name]');
      inputs.forEach(inp=>{
        const name  = inp.getAttribute('data-name');
        const field = inp.getAttribute('data-field');
        const row = map.get(name);
        if (!row) return;
        let v = Number(inp.value);
        if (!Number.isFinite(v)) v = 0;

        // QP는 100만 단위로 ×1,000,000
        if (name === NAME_QP) v = v * MILLION;

        row[field] = v;
      });
      // lack 재계산
      BASE.materials.materials.forEach(m=> m.lack = Math.max(0,(m.need||0)-(m.have||0)) );
    }

    async function bootPyodide(){
      if (window.pyodide) return window.pyodide;
      setP(10, 'Pyodide 초기화 중…');
      const p = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.26.2/full/' });
      window.pyodide = p;
      setP(40, '패키지 로드 중…');
      await p.loadPackage(['micropip']);
      setP(100, '준비 완료');
      return p;
    }

    async function writeFiles(){
      const { materials, quests, items } = BASE;
      const fs = pyodide.FS;
      fs.writeFile('materials.json', JSON.stringify(materials), { encoding: 'utf8' });
      fs.writeFile('event_quests.json', JSON.stringify(quests), { encoding: 'utf8' });
      fs.writeFile('event_items.json', JSON.stringify(items), { encoding: 'utf8' });
    }

    async function writeCorePyFromFile(){
      const txt = await fetch('calc_event_eff.py').then(r=>r.text());
      pyodide.FS.writeFile('calc_event_eff.py', txt, { encoding: 'utf8' });
    }

    async function runSimulation(){
      const out = document.querySelector('#out');
      out.textContent = '실행 중…';
      document.querySelector('#runBtn').disabled = true;
      try{
        readEditsIntoMaterials();

        // 사과 수량 읽기
        const apples = {
          gold:   Number(document.querySelector('#apple-gold').value||0),
          silver: Number(document.querySelector('#apple-silver').value||0),
          blue:   Number(document.querySelector('#apple-blue').value||0),
          copper: Number(document.querySelector('#apple-copper').value||0),
        };

        await writeFiles();
        await writeCorePyFromFile();

        const py = `
import sys, importlib.util

# 인자 고정
sys.argv = ["calc_event_eff.py",
            "--materials","materials.json",
            "--quests","event_quests.json",
            "--items","event_items.json"]

spec = importlib.util.spec_from_file_location("core","calc_event_eff.py")
core = importlib.util.module_from_spec(spec); spec.loader.exec_module(core)

# 사과 수량 주입(없으면 생성)
try:
    core.APPLE_COUNTS
except AttributeError:
    core.APPLE_COUNTS = {}
for k,v in ${JSON.stringify({gold:0,silver:0,blue:0,copper:0})}.items():
    pass
for k,v in ${'__JS_AP__'}.items():
    try:
        core.APPLE_COUNTS[k] = float(v) if v is not None else 0.0
    except Exception:
        core.APPLE_COUNTS[k] = 0.0

core.TABLE_FORMAT = "text"
core.TABLE_STYLE  = "ascii"

core.main()
open("run_log.txt","r",encoding="utf-8").read()
        `.replace('__JS_AP__', JSON.stringify(apples));

        const log = await pyodide.runPythonAsync(py);
        out.textContent = log || '(로그 비어 있음)';
        document.querySelector('#dlBtn').disabled = false;
      } catch (e) {
        out.textContent = '에러 발생: ' + (e && e.message ? e.message : e);
      } finally {
        document.querySelector('#runBtn').disabled = false;
      }
    }

    function resetInputs(){
      if (!RESET_SNAPSHOT) return;
      BASE.materials = structuredClone(RESET_SNAPSHOT);
      renderTable(document.querySelector('#search').value||'');
    }

    // ===== 3) 부팅 시퀀스 =====
    (async function init(){
      try{
        setP(5, '기본 데이터 로드');
        BASE = await loadJsonFiles();

        // ① 기본 시작: 모든 재료 0으로 세팅한 스냅샷을 활성화
        const zeroed = makeZeroBaseline(BASE.materials);
        BASE.materials = zeroed;
        applyHiddenItemPolicies();
        RESET_SNAPSHOT = structuredClone(BASE.materials); // Reset은 "0으로 세팅된 상태"로

        renderTable();

        await bootPyodide();
        document.querySelector('#boot').innerHTML = '<b class="ok">준비 완료!</b> 사과/아이템 수량을 입력하고 <b>시뮬레이션 실행</b>을 누르세요.';
        document.querySelector('#runBtn').disabled = false;
        document.querySelector('#resetBtn').disabled = false;

        document.querySelector('#dlBtn').addEventListener('click', ()=>{
          const txt = document.querySelector('#out').textContent||'';
          const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
          const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'run_log.txt' });
          a.click(); URL.revokeObjectURL(a.href);
        });
        document.querySelector('#runBtn').addEventListener('click', runSimulation);
        document.querySelector('#resetBtn').addEventListener('click', resetInputs);
        document.querySelector('#search').addEventListener('input', (e)=> renderTable(e.target.value||''));
        document.querySelector('#matUpload').addEventListener('change', handleUpload);
      }catch(err){
        document.querySelector('#boot').innerHTML = '<b class="err">초기화 실패:</b> '+err;
      }
    })();

    // ===== 업로드 핸들러 (materials.json / Chaldea userdata 둘 다 인식) =====
    async function handleUpload(ev){
      const file = ev.target.files && ev.target.files[0];
      if (!file) return;
      try{
        const txt = await file.text();
        const json = JSON.parse(txt);

        if (json && Array.isArray(json.materials)){
          // 1) materials.json 형태
          BASE.materials = json;
          applyHiddenItemPolicies();
          RESET_SNAPSHOT = structuredClone(BASE.materials);
          // 사과 자동 주입(사용자가 값 수정 전인 경우만)
          applyApplesFromMaterials(BASE.materials);
          renderTable(document.querySelector('#search').value||'');
        } else if (json && json.version && Array.isArray(json.users)){
          // 2) Chaldea userdata 형태
          if (!BASE.materials){
            // materials 스키마가 먼저 필요
            BASE.materials = await fetch('materials.json').then(r=>r.json());
          }
          applyChaldeaUserdata(json);
        } else {
          throw new Error('지원하지 않는 JSON 형식입니다.');
        }
      }catch(err){
        alert('JSON 업로드 실패: ' + err);
      }finally{
        ev.target.value = '';
      }
    }
  </script>
</body>
</html>
